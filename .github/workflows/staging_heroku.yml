name: Staging (Heroku)

on:
  push:
    branches:
      - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}-staging
  IMAGE_TAG: 0.0.0.9000

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
        - uses: actions/checkout@v1
        - name: Login to Heroku Container registry
          env:
            HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          run: heroku container:login
    #    - name: Build and push
    #      env:
    #        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
    #      run: heroku container:push -a ${{ secrets.HEROKU_APP_NAME_STAGING }} web
        - name: Build and push docker image
          uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
          with:
            context: .
            file: Dockerfile
            build-args: R_VERSION=4.1.2
            push: true
            #tags: ${{ steps.meta.outputs.tags }}
            tags: ${{ env.IMAGE_TAG }}
            labels: ${{ steps.meta.outputs.labels }}
        - name: Release
          env:
            HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          run: heroku container:release -a ${{ secrets.HEROKU_APP_NAME_STAGING }} web
